# Task: Fix reasoningContent Leak in bedrock_provider.py

## Problem Statement

MiniMax M2.1 via AWS Bedrock is emitting `reasoningContent` blocks (model's internal "thinking") that are being exposed to Discord users. This is a privacy and UX bug — users should not see the model's internal reasoning.

## Root Cause

In `nanobot/providers/bedrock_provider.py`, the `_parse_response()` function has this code:

```python
elif "reasoningContent" in block:
    pass  # skip reasoning/thinking blocks
```

This was later changed (incorrectly) to:

```python
elif "reasoningContent" in block:
    reasoning = block["reasoningContent"]
    # Use reasoning text as fallback if no text block found yet
    if text is None:
        thinking = reasoning.get("reasoningText", {})
        text = thinking.get("text") if isinstance(thinking, dict) else None
```

**The bug:** This treats `reasoningText.text` as a fallback response, which then gets sent to Discord. This is wrong — `reasoningContent` is internal model thinking and should NEVER be exposed to users.

## AWS Bedrock Converse API Documentation

### ContentBlock Structure

From `https://docs.aws.amazon.com/bedrock/latest/APIReference/API_ContentBlock.html`:

A `ContentBlock` in the response's `output.message.content` can contain **exactly one** of the following (mutually exclusive):

- `text`: The assistant's response text
- `image`, `document`, `video`, `audio`: Media content
- `toolUse`, `toolResult`: Tool interactions
- `guardContent`, `cachePoint`, `reasoningContent`: Special blocks

### reasoningContent Block Structure

From `https://docs.aws.amazon.com/bedrock/latest/APIReference/API_ReasoningContent.html`:

```json
{
  "reasoningContent": {
    "reasoningText": {
      "text": "string",
      "signature": "string"
    },
    "redactedContent": "blob"
  }
}
```

- `reasoningText.text`: The reasoning/thinking text generated by the model
- `reasoningText.signature`: A hash that enables multi-turn verification when reasoning is passed across requests
- `redactedContent`: Base64-encoded binary for any content that was redacted

### AWS's Intent

From the Converse API documentation:

> **reasoningContent** (Structure): Contains content regarding the reasoning that was carried out by the model to generate the response in the accompanying ContentBlock.

This means:
1. `reasoningContent` is *companion* content — it accompanies a response, it IS NOT the response
2. If a model only emits `reasoningContent` blocks, it has *not* produced a valid assistant response
3. The signature field exists specifically for multi-turn conversations where reasoning needs to be verified

Source: `https://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_Converse.html` and `https://docs.aws.amazon.com/bedrock/latest/APIReference/API_ContentBlock.html`

## Correct Behavior

1. **Log reasoning content at DEBUG level** — useful for debugging M2.1's behavior
2. **NEVER treat reasoningText.text as a response** — even as a fallback
3. **If no `text` blocks exist after processing all ContentBlocks**, the response is invalid:
   - Log the reasoning content at INFO level
   - Return a response with `content=[]` and no text
   - The agent loop will handle the empty response (retry or error)

## Files to Modify

- `nanobot/providers/bedrock_provider.py` — `_parse_response()` and `_chat_stream()`

## Specific Changes Required

### 1. Fix `_parse_response()`

Current (buggy):
```python
elif "reasoningContent" in block:
    reasoning = block["reasoningContent"]
    # Use reasoning text as fallback if no text block found yet
    if text is None:
        thinking = reasoning.get("reasoningText", {})
        text = thinking.get("text") if isinstance(thinking, dict) else None
```

Replace with:
```python
elif "reasoningContent" in block:
    # Log reasoning content for debugging — NEVER expose to users
    reasoning = block["reasoningContent"]
    thinking = reasoning.get("reasoningText", {})
    if isinstance(thinking, dict) and thinking.get("text"):
        logger.debug(f"Bedrock reasoning content (not exposed to user): {thinking['text'][:200]}...")
    # Do NOT use reasoning as fallback — it's internal model thinking
    continue  # skip to next block
```

Then, after the loop ends, add a check:
```python
# If no text content was found, the model emitted only reasoningContent or other non-text blocks
if text is None:
    logger.warning("Bedrock response contained no text blocks (model may have emitted only reasoning content)")
    text = ""  # Return empty response, agent loop will handle
```

### 2. Fix `_chat_stream()`

Current (buggy):
```python
elif "reasoningContent" in delta:
    pass  # skip reasoning deltas in stream
```

Replace with:
```python
elif "reasoningContent" in delta:
    # Log reasoning delta for debugging — don't yield to user
    reasoning = delta["reasoningContent"]
    thinking = reasoning.get("reasoningText", {})
    if isinstance(thinking, dict) and thinking.get("text"):
        logger.debug(f"Bedrock stream reasoning delta (not exposed): {thinking['text'][:100]}...")
    continue  # skip this delta
```

Then, after the stream ends, keep the existing warning:
```python
if not text_yielded:
    logger.warning("Bedrock stream: no text content yielded (model may have emitted only reasoning blocks)")
```

## Verification Commands

```bash
# After changes, run ruff
cd /Users/mhall/Workspaces/nanobot
python3 -m ruff check nanobot/providers/bedrock_provider.py

# Run tests
python3 -m pytest tests/ -q -k "not integration" --timeout=30 2>&1 | tail -5

# Manual smoke test
python3 -c "
from nanobot.providers.bedrock_provider import BedrockProvider
p = BedrockProvider()
print('BedrockProvider loads OK')
"
```

## Expected Outcomes

1. When M2.1 emits reasoning content, it is logged at DEBUG level, NOT sent to Discord
2. If M2.1 emits only reasoning blocks (no text), the agent receives an empty response
3. All existing tests pass
4. Ruff reports 0 violations